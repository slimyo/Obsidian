## **Diffusion Model**

---
- 前向轨迹
- 定义稳定概率分布：$$\pi(y)=\int dy'T_\pi (y|y';\beta)\pi (y')$$转移函数:$$q(x^{(t)}|x^{(t-1)})=T_\pi (x^{(t)}|x^{(t-1)};\beta)$$则前向规矩为:
$$q(x^{(0...T)})=q(x^{(0)})\prod_{t=1}^{T} q(x^{(t)}|x^{(t-1)})$$
---
- 反向轨迹$$p(x^{(T)})=\pi(x^{(T)})$$且:$$p(x^{(0...T)})=p(x^{(T)})\prod_{t=1}^{T} q(x^{(t-1)}|x^{(t)})$$
---
- 模型概率$$p(x^{(0)})=\int dx^{(0...T)}p(x^{(0...T)})$$


---
- 目标函数：$$L=\int dx^{(0)}q(x^{0})log [p(x^{0})]$$$$=\int dx^{(0)}q(x^{0})\cdot log[\int dx^{(1...T)}q(x^{(1...T)}|x^{(0)})\cdot p(x^{(T)})\prod_{t=1}^{T}\frac{p(x^{(t-1)}|x^{(t)})}{q(x^{(t)}|x^{(t-1)})}]$$应用Jensen不等式：$$L\ge \int dx^{(0...T)}q(x^{(0...T)})\cdot log[ p(x^{(T)})\prod_{t=1}^{T}\frac{p(x^{(t-1)}|x^{(t)})}{q(x^{(t)}|x^{(t-1)})}]=K$$打开log，边缘化无关变量$x^{0:T-1}$：$$K= \int dx^{(0...T)}q(x^{(0...T)})\cdot \sum _{t=1}^{T}log[ \frac{p(x^{(t-1)}|x^{(t)})}{q(x^{(t)}|x^{(t-1)})}]+\int dx^{(T)}q(x^{(T)})log(p(x^{(T)}))$$根据熵定义$H(x)=-\int dxp(x)log(p(x))$则有:$$K= \sum _{t=1}^{T}\int dx^{(0...T)}q(x^{(0...T)})\cdot log[ \frac{p(x^{(t-1)}|x^{(t)})}{q(x^{(t)}|x^{(t-1)})}]-H_p(x^{(T)})$$拿出第一项,有:$$K= \sum _{t=2}^{T}\int dx^{(0...T)}q(x^{(0...T)})log[ \frac{p(x^{(t-1)}|x^{(t)})}{q(x^{(t)}|x^{(t-1)})}]+\int dx^{(0...T)}q(x^{(0...T)})log[ \frac{p(x^{(0)}|x^{(1)})}{q(x^{(1)}|x^{(0)})}]-H_p(x^{(T)})$$边缘化无关变量，且由于$p(x^{(0)}|x^{(1)})=q(x^{(1)}|x^{(0)})\frac{\pi (x^{(0)})}{\pi (x^{(1)})}$则：$$K= \sum _{t=2}^{T}\int dx^{(0...T)}q(x^{(0...T)})log[ \frac{p(x^{(t-1)}|x^{(t)})}{q(x^{(t)}|x^{(t-1)})}]+\int dx^{(0,1)}q(x^{(0,1)})log[ \frac{q(x^{(1)}|x^{(0)})\pi(x^{(0)})}{q(x^{(1)}|x^{(0)})\pi(x^{(1)})}]-H_p(x^{(T)})$$由于设计前向过程，熵$H_p(x^{(t)})=H_p(x^{(T)})=\mathbb{E}_p(-log(\pi(x)))$则中项展开后消去：$$=\sum _{t=2}^{T}\int dx^{(0...T)}q(x^{(0...T)})log[ \frac{p(x^{(t-1)}|x^{(t)})}{q(x^{(t)}|x^{(t-1)})}]-H_p(x^{(T)})$$前向过程满足Markov性，即$q(x^{(t)}|x^{(t-1)})=q(x^{(t)}|x^{(t-1)},x^{(0)})$，则:$$=\sum _{t=2}^{T}\int dx^{(0...T)}q(x^{(0...T)})log[ \frac{p(x^{(t-1)}|x^{(t)})}{q(x^{(t)}|x^{(t-1)},x^{(0)})}]-H_p(x^{(T)})$$由贝叶斯规则$q(x^{(t)}|x^{(t-1)},x^{(0)})\frac{q(x^{(t-1)}|x^{(0)})}{q(x^{(t)}|x^{(0)})}=q(x^{(t-1)}|x^{(t)},x^{(0)})$：$$=\sum _{t=2}^{T}\int dx^{(0...T)}q(x^{(0...T)})log[ \frac{p(x^{(t-1)}|x^{(t)})}{q(x^{(t-1)}|x^{(t)},x^{(0)})}\frac{q(x^{(t-1)}|x^{(0)})}{q(x^{(t)}|x^{(0)})}]-H_p(x^{(T)})$$拆开,写成条件熵:$$=\sum _{t=2}^{T}\int dx^{(0...T)}q(x^{(0...T)})log[ \frac{p(x^{(t-1)}|x^{(t)})}{q(x^{(t-1)}|x^{(t)},x^{(0)})}]+\sum_{t=2}^{T}[H_q(x^{(t)}|x^{(0)})-H_q(x^{(t-1)}|x^{(0)})]-H_p(x^{(T)})$$合并：$$=\sum _{t=2}^{T}\int dx^{(0...T)}q(x^{(0...T)})log[ \frac{p(x^{(t-1)}|x^{(t)})}{q(x^{(t-1)}|x^{(t)},x^{(0)})}]+H_q(x^{(T)}|x^{(0)})-H_q(x^{(1)}|x^{(0)})-H_p(x^{(T)})$$由:$$D_{KL}(q(x^{(t-1)}|x^{(t)},x^{(0)})||p(x^{(t-1)}|x^{(t)}))=\int dx^{(t-1)}q(x^{(t-1)}|x^{(t)},x^{(0)})log(\frac{q(x^{(t-1)}|x^{(t)},x^{(0)})}{p(x^{(t-1)}|x^{(t)})})$$得到：
---
$$\begin{align*}L\ge K\\
&=\sum _{t=2}^{T}\int dx^{(0,t)}q(x^{(0,t)})D_{KL}(q(x^{(t-1)}|x^{(t)},x^{(0)})||p(x^{(t-1)}|x^{(t)}))\\
&+H_q(x^{(T)}|x^{(0)})-H_q(x^{(1)}|x^{(0)})-H_p(x^{(T)})
\end{align*}$$
---
